<!DOCTYPE html>
<html lang="ptbr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Bin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
</head>


<body onload="atualizaSelectBairro(), atualizarFeed(), obterDadosGrafico()">
    <div class="content">
        <div class="menu">
            <h3>Bairros</h3>
            <ul class="menu_list">
                <a href="tela_dashboard.html">
                    <li>Todos os bairros</li>
                </a>
                <a href="boa_vista.html">
                    <li>Boa Vista</li>
                </a>
                <a href="jardim_paulista.html">
                    <li>Jardim Paulista</li>
                </a>
                <a href="jabaquara.html">
                    <li>Jabaquara</li>
                </a>
                <a href="santa_cecilia.html">
                    <li>Santa Cecília</li>
                </a>
                <a href="santo_amaro.html">
                    <li>Santo Amaro</li>
                </a>
            </ul>
            <h3>Configurações</h3>
            <ul class="menu_list">
                <div id="div_links">

                </div>
                <a href="Visualizacao_perfil.html">
                    <li>Usuário</li>
                </a>
            </ul>

            <a class="logOut" href="index.html">Sair <img src="../img/logOut.png" alt=""></a>

            <div id="usuario" class="foto_user_box">
                <!-- <a href="Visualizacao_perfil.html"><img src="../img/perfil.png" alt=""></a>  -->

            </div>
        </div>
        <div class="conteudo">
            <h1>Todos os bairros</h1>
            <img class="logo" src="img/logo_smartBin-removebg-preview.png" alt="">

            <div class="box_dados">
                <div>
                    <h3>Lixeira Nivel <span style="color: #297011;">Baixo</span> </h3>
                    <p id="metrica_card_baixo">0</p>
                </div>
                <div>
                    <h3>Lixeira Nivel <span style="color: #d1ce00;">Médio</span></h3>
                    <p id="metrica_card_medio">0</p>
                </div>

                <div>
                    <h3>Lixeira Nível <span style="color: red;">Alto</span></h3>
                    <p id="metrica_card_alto">0</p>
                </div>
            </div>
            <div id="filtroSelect">
                <select id="select_bairro" onchange="atualizarFeed()">
                    <option selected value="1">Todos os Bairros</option>
                </select>
            </div>
            <div class="cards_grid" id="card_pai">


                <!-- <div id="card" class="card">

                    <a href="tela_historico.html">

                    <h3>Lixeira 1</h3> </a>
                    </a>
                    <i id="lixeira" style="color: red;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: Consolação, 101, Boa vista</h4>
                    <h4>Nível: <span style="color: red;">Alto</span></h4>
                </div>
                <div class="card">

                    <h3>Lixeira 2</h3>
                    <i style="color: red;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: bento alves, 544, Jabaquara</h4>
                    <h4>Nível: <span style="color: red;">Alto</span></h4>
                </div>


                <div class="card">

                    <h3>Lixeira 5</h3>
                    <i style="color: red;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: Domingos, 54, Santo Amaro</h4>
                    <h4>Nível: <span style="color: red;">Alto</span></h4>
                </div>

                <div class="card">

                    <h3>Lixeira 6</h3>
                    <i style="color: red;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: carlos de campos, 105, Boa vista</h4>
                    <h4>Nível: <span style="color: red;">Alto</span></h4>
                </div>

                <div class="card">

                    <h3>Lixeira 7</h3>
                    <i style="color: red;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: Haiti 32, Jardim paulista</h4>
                    <h4>Nível: <span style="color: red;">Alto</span></h4>
                </div>
                <div class="card">

                    <h3>Lixeira 10</h3>
                    <i style="color: red;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: santinho freitas, 5487, Santo Amaro</h4>
                    <h4>Nível: <span style="color: red;">Alto</span></h4>
                </div>
                <div class="card">
                    <h3>Lixeira 4</h3>
                    <i style="color: #d1ce00;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: santos drummond, 1047, Santa Cecília</h4>
                    <h4>Nível: <span style="color: #d1ce00;">Medio</span></h4>
                </div>

                <div class="card">

                    <h3>Lixeira 9</h3>
                    <i style="color: #d1ce00;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: Alameda franca, 1047, Jardim paulista </h4>
                    <h4>Nível: <span style="color: #d1ce00;">Medio</span></h4>
                </div>

                <div class="card">
                    <h3>Lixeira 3</h3>
                    <i style="color: #297011;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: owald melo, 2584, Boa Vista</h4>
                    <h4>Nível: <span style="color: #297011;">Baixo</span></h4>
                </div>
                <div class="card">

                    <h3>Lixeira 8</h3>
                    <i style="color: #297011;" class="fa-solid fa-dumpster"></i>
                    <h4>Rua: Freire farto, 254, Jabaquara</h4>
                    <h4>Nível: <span style="color: #297011;">Baixo</span></h4>
                </div> -->
            </div>

            <h1 class="titulo_grafico">Gráfico:</h1>
            <div class="grafico_box">
                <select id="select_semana">
                    <option value="1">Essa semana</option>
                    <option value="2">Semana - 29/04/2024 até 05/05/2024</option>
                    <option value="3">Semana - 22/04/2024 até 28/04/2024</option>
                    <option value="4">Semana - 15/04/2024 até 21/04/2024</option>
                    <option value="5">Semana - 08/04/2024 até 14/04/2024</option>
                    <option value="6">Semana - 01/04/2024 até 07/04/2024</option>
                </select>
                <canvas id="myChartCanvas"></canvas>
            </div>
        </div>
    </div>
</body>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="area_edit">
            <h3>Lixeira 1</h3>
            <a href="#" id="EditModal"><i class="fa-solid fa-pen"></i></a>
        </div>
        <!-- <i class="fa-solid fa-pen"></i> -->


        <i style="color: red;" class="fa-solid fa-dumpster"></i>
        <h4>Rua: Consolação, 101, Boa vista</h4>
        <h4>Nível: <span style="color: red;">Alto</span></h4>
        <h3>Horarios</h3>
        <div>
            <h5>Nivel: Médio - 09:45:58 do dia 03/04/24 até 15:44:08 do dia 03/04/24</h5>
            <h5>Nivel: Alto - 15:44:08 do dia 03/04/24 até 20:22:19 do dia 03/04/24</h5>
        </div>
        <div class="btn btn_historico">
            <a href="#" id="openModal">
                <button class="botao">Informações</button>
            </a>
        </div>
    </div>
</div>

<!-- <div id="ModalEdicao" class="modal">
    <div class="modal-content">
        <span class="closeEdit">&times;</span>
        <h3 contenteditable="true">Lixeira 1</h3>
        <i style="color: red;" class="fa-solid fa-dumpster"></i>
        <h4 contenteditable="true">Rua: Consolação, 101, Boa vista</h4>
        <h4>Nível: <span style="color: red;">Alto</span></h4>
        <h3>Horarios</h3>
        <div>
            <h5>Nivel: Médio - 09:45:58 do dia 03/04/24 até 15:44:08 do dia 03/04/24</h5>
            <h5>Nivel: Alto - 15:44:08 do dia 03/04/24 até 20:22:19 do dia 03/04/24</h5>

        </div>
        <div class="btn">
            <button class="botao" id="saveButton">salvar</button>
        </div>
    </div>
</div> -->

</html>

<script>


    document.getElementById('openModal').addEventListener('click', function () {
        document.getElementById('modal').style.display = 'block';
        document.querySelector('.conteudo').style.display = 'none'; // Oculta a div conteudo
    });

    document.querySelector('.close').addEventListener('click', function () {
        document.getElementById('modal').style.display = 'none';
        document.querySelector('.conteudo').style.display = 'block'; // Mostra a div conteudo novamente
    });

    document.getElementById('EditModal').addEventListener('click', function () {
        document.getElementById('ModalEdicao').style.display = 'block';
        document.querySelector('.openModal').style.display = 'none'; // Oculta a div conteudo
    });

    document.querySelector('.closeEdit').addEventListener('click', function () {
        document.getElementById('ModalEdicao').style.display = 'none';
        document.querySelector('.openModal').style.display = 'block'; // Mostra a div conteudo novamente
    });


    const ctx = document.getElementById('myChart');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'],
            datasets: [{
                label: 'Lixeira nivel médio',
                data: [1, 3, 2, 4, 1, 0, 1],
                borderWidth: 1,
                backgroundColor: 'yellow'
            },
            {
                label: 'Lixeira nivel alto',
                data: [5, 2, 4, 1, 2, 6, 4],
                borderWidth: 1,
                backgroundColor: 'red'
            },
            {
                label: 'Lixeira nivel baixo',
                data: [4, 5, 4, 5, 7, 4, 5],
                borderWidth: 1,
                backgroundColor: 'green'
            }
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantidade de lixeiras'
                    }
                }
            },

        }
    });


    function atualizaSelectBairro() {
        var idEmpresa = sessionStorage.EMPRESAID;

        fetch(`/lixeira/listarBairro/${idEmpresa}`).then(function (resposta) {
            console.log("Dados recebidos Bairros: ", JSON.stringify(resposta));
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        var feed = document.getElementById("feed_container");
                        var mensagem = document.createElement("span");
                        mensagem.innerHTML = "Nenhum resultado encontrado."
                        feed.appendChild(mensagem);
                        throw "Nenhum resultado encontrado!!";
                    }

                    resposta.json().then(function (resposta) {
                    console.log("Dados recebidos CARD LIXEIRA: ", JSON.stringify(resposta));

                    var select = document.getElementById("select_bairro")
                    for (let i = 0; i < resposta.length; i++) {
                        var tabela = resposta[i];

                        var opt = document.createElement("option");

                        opt.innerHTML = `<option value="${tabela.Bairro}">${tabela.Bairro}</option>`;

                        select.appendChild(opt);

                    }
                })
            } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });
    }

    function atualizarFeed() {
        // parte que coloca o nome e o tipo do usuário embaixo
        card_pai.innerHTML = "";

        var baixoMetrica = 0;
        var medioMetrica = 0;
        var altoMetrica = 0;

        var nome = sessionStorage.NOME_USUARIO;
        var tipo = sessionStorage.TIPO_USUARIO;

        var selectValor = select_bairro.value;

        usuario.innerHTML = `<h4>${nome}</h4>
                <h5>${tipo}</h5>`


        // parte que decide se irá mostrar opções como add um usuário e entre outros
        if (tipo == 'Administrador') {
            div_links.innerHTML = `<a href="tela_cadastro_lixeira.html">
                        <li>Adicionar lixeira</li>
                    </a>
                    <a href="tela_cadastro_logado.html">
                        <li>Adicionar Usuário</li>
                    </a>
                    <a href= "http://localhost:3332" >
                    <li>Área Técnica</li>
                </a>`
        }


        var idEmpresa = sessionStorage.EMPRESAID;
        fetch(`/lixeira/listar/${idEmpresa}/${selectValor}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    var feed = document.getElementById("feed_container");
                    var mensagem = document.createElement("span");
                    mensagem.innerHTML = "Nenhum resultado encontrado."
                    feed.appendChild(mensagem);
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos CARD LIXEIRA: ", JSON.stringify(resposta));

                    var feed = document.getElementById("feed_container");
                    for (let i = 0; i < resposta.length; i++) {
                        var lixeira = resposta[i];

                        // Criação do elemento principal (div) e definição da classe
                        var cardElement = document.createElement("div");
                        cardElement.className = "card";

                        // Criação dos elementos HTML internos
                        var h3Element = document.createElement("h3");
                        var iconElement = document.createElement("i");
                        var h4RuaElement = document.createElement("h4");
                        var h4NivelElement = document.createElement("h4");
                        var spanNivelElement = document.createElement("span");
                        var spanNumeroElement = document.createElement("span");

                        // Definição do conteúdo e atributos dos elementos
                        h3Element.innerHTML = lixeira.nomeLixeira;

                        iconElement.className = "fa-solid fa-dumpster";
                        iconElement.style.color = "red";


                        // CÓDIGO ABAIXO TESTE A SER VALIDADO


                        if (lixeira.nivelBaixo == 0 && lixeira.nivelAlto == 0) {
                            console.log(`NIVEL BAIXO --- VERDE`)

                            h4RuaElement.innerHTML = `Cep: ${lixeira.cep}, n° ${lixeira.numero}`;
                            spanNumeroElement.innerHTML = '<b>Complemento:</b>' + lixeira.Complemento + " Alto:" + lixeira.nivelAlto + " Baixo: " + lixeira.nivelBaixo;
                            h4NivelElement.innerHTML = "Nível: ";
                            spanNivelElement.innerHTML = "Baixo";
                            spanNivelElement.style.color = "green";
                            iconElement.style.color = "green";
                            baixoMetrica++;
                            metrica_card_baixo.innerHTML = baixoMetrica;


                        } else if (lixeira.nivelBaixo == 1 && lixeira.nivelAlto == 0) {

                            console.log(`NIVEL MÉDIO --- AMARELO`)
                            h4RuaElement.innerHTML = `Cep: ${lixeira.cep}, n° ${lixeira.numero}`;
                            spanNumeroElement.innerHTML = '<b>Complemento:</b>' + lixeira.Complemento + " Alto " + lixeira.nivelAlto + " Baixo: " + lixeira.nivelBaixo;
                            h4NivelElement.innerHTML = "Nível: ";
                            spanNivelElement.innerHTML = "Médio";
                            spanNivelElement.style.color = "yellow";
                            iconElement.style.color = "yellow";
                            medioMetrica++;
                            metrica_card_medio.innerHTML = medioMetrica;

                        } else if (lixeira.nivelBaixo == 1 && lixeira.nivelAlto == 1) {
                            console.log(`NIVEL CRITICO--- VERMELHO`)

                            h4RuaElement.innerHTML = `Cep: ${lixeira.cep}, n° ${lixeira.numero}`;
                            spanNumeroElement.innerHTML = '<b>Complemento:</b>' + lixeira.Complemento + " Alto " + lixeira.nivelAlto + " Baixo: " + lixeira.nivelBaixo;
                            h4NivelElement.innerHTML = "Nível: ";
                            spanNivelElement.innerHTML = "Alto";
                            spanNivelElement.style.color = "red";
                            iconElement.style.color = "red";
                            altoMetrica++;
                            metrica_card_alto.innerHTML = altoMetrica;
                        }

                        // CÓDIGO ACIMA TESTE A SER VALIDADO


                        // h4RuaElement.innerHTML = lixeira.cep;
                        // spanNumeroElement.innerHTML = '<b>Número:</b>' + lixeira.numero + " Ni " + lixeira.nivelAlto;
                        // h4NivelElement.innerHTML = "Nível: ";
                        // spanNivelElement.innerHTML = "Alto";
                        // spanNivelElement.style.color = "red";


                        // Construção da hierarquia dos elementos
                        h4NivelElement.appendChild(spanNivelElement);
                        cardElement.appendChild(h3Element);
                        cardElement.appendChild(iconElement);
                        cardElement.appendChild(h4RuaElement);
                        cardElement.appendChild(spanNumeroElement);
                        cardElement.appendChild(h4NivelElement);


                        // Adicionando o cardElement ao elemento de destino no DOM (ajuste o seletor conforme necessário)
                        document.getElementById("card_pai").appendChild(cardElement);
                    }


                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }


    // GRAFICO LIXEIRAS



    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    var idEmpresa = sessionStorage.EMPRESAID;

    function obterDadosGrafico(idEmpresa) {

        //alterarTitulo(idEmpresa)

        var idEmpresa = sessionStorage.EMPRESAID;

        fetch(`/medidas/ultimas/${idEmpresa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos GRAFICO: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    plotarGrafico(resposta, idEmpresa);

                });
            } else {
                console.error('Nenhum dado GRAFICO encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idEmpresa) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: [],
            datasets: [
                {
                    label: 'Nível Baixo',
                    data: [],
                    backgroundColor: 'green'
                },
                {
                    label: 'Nível Médio',
                    data: [],
                    backgroundColor: 'yellow'
                },
                {
                    label: 'Nível Alto',
                    data: [],
                    backgroundColor: 'red'
                }
            ]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela função "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        let diasSemana = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
        diasSemana.forEach(dia => {
            labels.push(dia);
            dados.labels.push(dia);
            dados.datasets[0].data.push(0); // Nível Baixo
            dados.datasets[1].data.push(0); // Nível Médio
            dados.datasets[2].data.push(0); // Nível Alto
        });

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (let i = 0; i < resposta.length; i++) {
            let registro = resposta[i];
            let diaIndex = labels.indexOf(registro.dia);

            if (registro.nivelBaixo === 1 && registro.nivelAlto === 0) {
                dados.datasets[1].data[diaIndex] += 1; // Nível Médio
            } else {
                if (registro.nivelBaixo !== null && registro.nivelBaixo !== undefined) {
                    dados.datasets[0].data[diaIndex] += registro.nivelBaixo;
                }
                if (registro.nivelAlto !== null && registro.nivelAlto !== undefined) {
                    dados.datasets[2].data[diaIndex] += registro.nivelAlto;
                }
            }
        }


        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Dias da Semana'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    }
                }
            }
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas`),
            config
        );
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idEmpresa, dados, myChart) {

        fetch(`/medidas/tempo-real/${idEmpresa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    obterdados(idEmpresa);
                    // alertar(novoRegistro, idEmpresa);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    let avisoCaptura = document.getElementById(`avisoCaptura${idEmpresa}`)
                    avisoCaptura.innerHTML = ""


                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar

            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

</script>